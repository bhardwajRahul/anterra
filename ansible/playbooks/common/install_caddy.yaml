---
- name: Install and Configure Caddy with Cloudflare DNS Plugin
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Fetch Cloudflare API token from Bitwarden
      shell: bws secret get "{{ cloudflare_api_token_secret_id }}" --access-token "{{ bws_access_token }}" --output json
      register: cloudflare_token_result
      no_log: true
      changed_when: false
      delegate_to: localhost
      become: false
      run_once: true
      when: cloudflare_api_token_secret_id is defined

    - name: Set Cloudflare API token fact
      set_fact:
        cloudflare_api_token: "{{ (cloudflare_token_result.stdout | from_json).value }}"
      no_log: true
      run_once: true
      delegate_to: localhost
      when:
        - cloudflare_api_token_secret_id is defined
        - cloudflare_token_result.stdout is defined

    - name: Distribute Cloudflare API token to all target hosts
      set_fact:
        cloudflare_api_token: "{{ hostvars['localhost']['cloudflare_api_token'] }}"
      no_log: true
      when:
        - cloudflare_api_token_secret_id is defined
        - hostvars['localhost']['cloudflare_api_token'] is defined

  vars:
    caddy_binary_path: "/usr/bin/caddy"
    caddy_config_dir: "/etc/caddy"
    caddy_data_dir: "/var/lib/caddy"
    caddy_caddyfile_path: "/etc/caddy/Caddyfile"
    caddy_cloudflare_token_path: "/etc/caddy/cloudflare_token"
    # cloudflare_api_token_secret_id should be defined in vault
    # bws_access_token should be defined in vault
    # Map Ansible architecture to Caddy download architecture
    caddy_arch_map:
      x86_64: amd64
      aarch64: arm64
      armv7l: armv7
    caddy_arch: "{{ caddy_arch_map[ansible_architecture] | default('amd64') }}"
    caddy_download_url: "https://caddyserver.com/api/download?os=linux&arch={{ caddy_arch }}&p=github.com%2Fcaddy-dns%2Fcloudflare&idempotency=23757119970210"

  tasks:
    - name: Create caddy system group
      group:
        name: caddy
        system: true
        state: present

    - name: Create caddy system user
      user:
        name: caddy
        group: caddy
        system: true
        shell: /usr/sbin/nologin
        home: "{{ caddy_data_dir }}"
        create_home: true
        comment: "Caddy web server"
        state: present

    - name: Create Caddy configuration directory
      file:
        path: "{{ caddy_config_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create Caddy data directory
      file:
        path: "{{ caddy_data_dir }}"
        state: directory
        owner: caddy
        group: caddy
        mode: '0750'

    - name: Download Caddy binary with Cloudflare DNS plugin
      get_url:
        url: "{{ caddy_download_url }}"
        dest: "{{ caddy_binary_path }}"
        mode: '0755'
        owner: root
        group: root
      register: caddy_download

    - name: Verify Caddy installation
      command: caddy version
      register: caddy_version_check
      changed_when: false

    - name: Display Caddy version
      debug:
        msg: "Caddy installed: {{ caddy_version_check.stdout }}"

    - name: Verify Cloudflare DNS plugin is installed
      shell: caddy list-modules | grep cloudflare
      register: caddy_cloudflare_check
      changed_when: false
      failed_when: caddy_cloudflare_check.rc != 0

    - name: Display Cloudflare DNS plugin status
      debug:
        msg: "Cloudflare DNS plugin found: {{ caddy_cloudflare_check.stdout }}"

    - name: Create Cloudflare token file for Caddy
      copy:
        content: "CLOUDFLARE_API_TOKEN={{ cloudflare_api_token }}"
        dest: "{{ caddy_cloudflare_token_path }}"
        owner: caddy
        group: caddy
        mode: '0400'
      no_log: true
      when: cloudflare_api_token_secret_id is defined

    - name: Create minimal Caddyfile
      copy:
        content: ""
        dest: "{{ caddy_caddyfile_path }}"
        owner: root
        group: root
        mode: '0644'
        force: false

    - name: Configure Cloudflare DNS-01 ACME challenge
      ansible.builtin.blockinfile:
        path: "{{ caddy_caddyfile_path }}"
        block: |
          # Global configuration for TLS and ACME challenges
          {
            # Use Cloudflare DNS-01 challenge for automatic certificate management
            acme_dns cloudflare {env.CLOUDFLARE_API_TOKEN}
          }
        marker: "# {mark} ANSIBLE MANAGED BLOCK FOR GLOBAL TLS"
        insertbefore: "BEGIN"
      notify: Reload Caddy

    - name: Create Caddy systemd service file
      copy:
        content: |
          [Unit]
          Description=Caddy
          Documentation=https://caddyserver.com/docs/
          After=network.target network-online.target
          Requires=network-online.target

          [Service]
          Type=notify
          User=caddy
          Group=caddy
          ExecStart=/usr/bin/caddy run --environ --config /etc/caddy/Caddyfile
          ExecReload=/usr/bin/caddy reload --config /etc/caddy/Caddyfile --force
          TimeoutStopSec=5s
          LimitNOFILE=1048576
          PrivateTmp=true
          ProtectSystem=full
          AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE

          EnvironmentFile={{ caddy_cloudflare_token_path }}

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/caddy.service
        owner: root
        group: root
        mode: '0644'
      register: caddy_service_file

    - name: Reload systemd daemon
      systemd:
        daemon_reload: true
      when: caddy_service_file.changed

    - name: Enable and start Caddy service
      systemd:
        name: caddy
        enabled: true
        state: started

    - name: Check Caddy service status
      systemd:
        name: caddy
      register: caddy_service_status

    - name: Display Caddy service status
      debug:
        msg: "Caddy service is {{ caddy_service_status.status.ActiveState }}"

  handlers:
    - name: Reload Caddy
      ansible.builtin.systemd:
        name: caddy
        state: reloaded

---
# Fetch Bitwarden secrets for VPS connection (always runs, even with --limit)
- name: Fetch Bitwarden secrets for ovh_vps
  hosts: localhost
  connection: local
  gather_facts: false
  tags: always
  tasks:
    - name: Fetch OVH VPS SSH password from Bitwarden
      shell: bws secret get "{{ ovh_vps_ssh_guid }}" --access-token "{{ bws_access_token }}" --output json
      register: ovh_ssh_password_result
      no_log: true
      changed_when: false
      when: ovh_vps_ssh_guid is defined
      delegate_to: localhost

    - name: Set OVH VPS SSH password fact
      set_fact:
        ovh_vps_ssh_password: "{{ (ovh_ssh_password_result.stdout | from_json).value }}"
      no_log: true
      when:
        - ovh_vps_ssh_guid is defined
        - ovh_ssh_password_result.stdout is defined

    - name: Add ovh_vps_ssh_password to hostvars
      add_host:
        name: ovh_vps
        ovh_vps_ssh_password: "{{ ovh_vps_ssh_password }}"
      when: ovh_vps_ssh_password is defined

- name: Install and Configure Caddy with Cloudflare DNS Plugin
  hosts: caddy_hosts
  become: true
  gather_facts: true

  vars:
    caddy_binary_path: "/usr/bin/caddy"
    caddy_config_dir: "/etc/caddy"
    caddy_data_dir: "/var/lib/caddy"
    caddy_caddyfile_path: "/etc/caddy/Caddyfile"
    caddy_cloudflare_token_path: "/etc/caddy/cloudflare_token"
    # cloudflare_api_token_secret_id should be defined in vault
    # bws_access_token should be defined in vault
    # Map Ansible architecture to Caddy download architecture
    caddy_arch_map:
      x86_64: amd64
      aarch64: arm64
      armv7l: armv7
    caddy_arch: "{{ caddy_arch_map[ansible_architecture] | default('amd64') }}"
    caddy_download_url: "https://caddyserver.com/api/download?os=linux&arch={{ caddy_arch }}&p=github.com%2Fcaddy-dns%2Fcloudflare&idempotency=23757119970210"

  tasks:
    # Create caddy system group
    - name: Create caddy system group
      group:
        name: caddy
        system: true
        state: present

    # Create caddy system user with secure settings
    - name: Create caddy system user
      user:
        name: caddy
        group: caddy
        system: true
        shell: /usr/sbin/nologin
        home: "{{ caddy_data_dir }}"
        create_home: true
        comment: "Caddy web server"
        state: present

    # Create configuration directory
    - name: Create Caddy configuration directory
      file:
        path: "{{ caddy_config_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    # Create data directory for certificates and state
    - name: Create Caddy data directory
      file:
        path: "{{ caddy_data_dir }}"
        state: directory
        owner: caddy
        group: caddy
        mode: '0750'

    # Download Caddy with cloudflare-dns plugin
    - name: Download Caddy binary with Cloudflare DNS plugin
      get_url:
        url: "{{ caddy_download_url }}"
        dest: "{{ caddy_binary_path }}"
        mode: '0755'
        owner: root
        group: root
      register: caddy_download

    # Verify Caddy installation
    - name: Verify Caddy installation
      command: caddy version
      register: caddy_version_check
      changed_when: false

    - name: Display Caddy version
      debug:
        msg: "Caddy installed: {{ caddy_version_check.stdout }}"

    # List Caddy modules to verify cloudflare-dns plugin
    - name: Verify Cloudflare DNS plugin is installed
      shell: caddy list-modules | grep cloudflare
      register: caddy_cloudflare_check
      changed_when: false
      failed_when: caddy_cloudflare_check.rc != 0

    - name: Display Cloudflare DNS plugin status
      debug:
        msg: "Cloudflare DNS plugin found: {{ caddy_cloudflare_check.stdout }}"

    # Fetch Cloudflare API token from Bitwarden Secrets Manager (locally on controller)
    - name: Fetch Cloudflare API token from Bitwarden (run locally)
      shell: bws secret get "{{ cloudflare_api_token_secret_id }}" --access-token "{{ bws_access_token }}" --output json
      register: cloudflare_token_result_local
      no_log: true
      changed_when: false
      when: cloudflare_api_token_secret_id is defined
      delegate_to: localhost

    - name: Parse Cloudflare token from Bitwarden response
      set_fact:
        cloudflare_api_token: "{{ (cloudflare_token_result_local.stdout | from_json).value }}"
      no_log: true
      when:
        - cloudflare_api_token_secret_id is defined
        - cloudflare_token_result_local.stdout is defined

    # Store Cloudflare token securely for Caddy to use
    - name: Create Cloudflare token file for Caddy
      copy:
        content: "{{ cloudflare_api_token }}"
        dest: "{{ caddy_cloudflare_token_path }}"
        owner: caddy
        group: caddy
        mode: '0400'
      no_log: true
      when: cloudflare_api_token_secret_id is defined

    # Create minimal Caddyfile if it doesn't exist
    - name: Create minimal Caddyfile
      copy:
        content: ""
        dest: "{{ caddy_caddyfile_path }}"
        owner: root
        group: root
        mode: '0644'
        force: false

    # Add global TLS configuration block for Cloudflare DNS-01 challenge
    - name: Configure Cloudflare DNS-01 ACME challenge
      ansible.builtin.blockinfile:
        path: "{{ caddy_caddyfile_path }}"
        block: |
          # Global configuration for TLS and ACME challenges
          {
            # Use Cloudflare DNS-01 challenge for automatic certificate management
            acme_dns cloudflare {env.CLOUDFLARE_API_TOKEN}
          }
        marker: "# {mark} ANSIBLE MANAGED BLOCK FOR GLOBAL TLS"
        insertbefore: "BEGIN"
      notify: Reload Caddy

    # Create systemd service file
    - name: Create Caddy systemd service file
      copy:
        content: |
          [Unit]
          Description=Caddy
          Documentation=https://caddyserver.com/docs/
          After=network.target network-online.target
          Requires=network-online.target

          [Service]
          Type=notify
          User=caddy
          Group=caddy
          ExecStart=/usr/bin/caddy run --environ --config /etc/caddy/Caddyfile
          ExecReload=/usr/bin/caddy reload --config /etc/caddy/Caddyfile --force
          TimeoutStopSec=5s
          LimitNOFILE=1048576
          PrivateTmp=true
          ProtectSystem=full
          AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE

          # Load Cloudflare API token as environment variable
          Environment=CLOUDFLARE_API_TOKEN_FILE={{ caddy_cloudflare_token_path }}
          EnvironmentFile=-/etc/caddy/caddy.env

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/caddy.service
        owner: root
        group: root
        mode: '0644'
      register: caddy_service_file

    # Create environment file for additional configuration
    - name: Create Caddy environment file
      copy:
        content: |
          # Additional environment variables for Caddy
          # Read Cloudflare token from file
          CLOUDFLARE_API_TOKEN={{ cloudflare_api_token | default('') }}
        dest: /etc/caddy/caddy.env
        owner: caddy
        group: caddy
        mode: '0400'
      no_log: true
      when: cloudflare_api_token_secret_id is defined

    # Reload systemd daemon if service file changed
    - name: Reload systemd daemon
      systemd:
        daemon_reload: true
      when: caddy_service_file.changed

    # Enable and start Caddy service
    - name: Enable and start Caddy service
      systemd:
        name: caddy
        enabled: true
        state: started

    # Verify Caddy service is running
    - name: Check Caddy service status
      systemd:
        name: caddy
      register: caddy_service_status

    - name: Display Caddy service status
      debug:
        msg: "Caddy service is {{ caddy_service_status.status.ActiveState }}"

    # Configuration complete. Caddy is now installed and running.
    # Next steps:
    # - Global TLS configuration uses Cloudflare DNS-01 challenge for automatic certificate management
    # - Reverse proxy records are added by the 'caddy_reverse_proxy.yaml' playbook
    # - Cloudflare DNS A records are managed by OpenTofu
    # - Cloudflare API token is securely stored at /etc/caddy/cloudflare_token
    # - View logs: journalctl -u caddy -f
    # - Check status: systemctl status caddy

  handlers:
    - name: Reload Caddy
      ansible.builtin.systemd:
        name: caddy
        state: reloaded

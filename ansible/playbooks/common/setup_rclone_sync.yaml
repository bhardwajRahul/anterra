---
- name: Fetch SSH credentials from Bitwarden
  hosts: localhost
  connection: local
  gather_facts: false
  tags: always
  tasks:
    - name: Fetch Docker SSH password from Bitwarden
      shell: bws secret get {{ docker_pve2_ssh_password_uuid }} --access-token "{{ bws_access_token }}" --output json
      register: docker_ssh_password_result
      changed_when: false
      no_log: true
      when: docker_pve2_ssh_password_uuid is defined

    - name: Set Docker SSH password fact
      set_fact:
        docker_ssh_pass: "{{ (docker_ssh_password_result.stdout | from_json).value }}"
      no_log: true
      when:
        - docker_pve2_ssh_password_uuid is defined
        - docker_ssh_password_result.stdout is defined

    - name: Add credentials to docker_pve2 host
      add_host:
        name: docker_pve2
        ansible_ssh_pass: "{{ docker_ssh_pass }}"
        ansible_become_pass: "{{ docker_ssh_pass }}"
      no_log: true
      when: docker_ssh_pass is defined

- name: Setup rclone bidirectional sync between Google Drive and OneDrive
  hosts: docker_pve2
  become: true
  vars:
    rclone_user: dockeruser
    gdrive_remote: "googledrive"
    onedrive_remote: "onedrive"
    gdrive_path: "Documents"
    onedrive_path: "Documents"
    sync_interval: "15min"

  tasks:
    - name: Verify rclone is installed
      command: rclone version
      register: rclone_version
      changed_when: false

    - name: Display rclone version
      debug:
        msg: "{{ rclone_version.stdout_lines }}"

    - name: Verify rclone remotes are configured
      command: rclone listremotes
      become_user: "{{ rclone_user }}"
      register: rclone_remotes
      changed_when: false

    - name: Fail if Google Drive remote not configured
      fail:
        msg: "Google Drive remote '{{ gdrive_remote }}:' not found. Run configure_rclone.yaml first."
      when: "gdrive_remote + ':' not in rclone_remotes.stdout"

    - name: Fail if OneDrive remote not configured
      fail:
        msg: "OneDrive remote '{{ onedrive_remote }}:' not found. Run configure_rclone.yaml first."
      when: "onedrive_remote + ':' not in rclone_remotes.stdout"

    - name: Ensure Google Drive Documents folder exists
      command: "rclone mkdir {{ gdrive_remote }}:{{ gdrive_path }}"
      become_user: "{{ rclone_user }}"
      register: gdrive_mkdir
      changed_when: false
      failed_when: false

    - name: Ensure OneDrive Documents folder exists
      command: "rclone mkdir {{ onedrive_remote }}:{{ onedrive_path }}"
      become_user: "{{ rclone_user }}"
      register: onedrive_mkdir
      changed_when: false
      failed_when: false

    - name: Verify Google Drive folder is accessible
      command: "rclone lsd {{ gdrive_remote }}:{{ gdrive_path }}"
      become_user: "{{ rclone_user }}"
      register: gdrive_check
      changed_when: false

    - name: Verify OneDrive folder is accessible
      command: "rclone lsd {{ onedrive_remote }}:{{ onedrive_path }}"
      become_user: "{{ rclone_user }}"
      register: onedrive_check
      changed_when: false

    - name: Create rclone bisync state directory
      file:
        path: "/home/{{ rclone_user }}/.cache/rclone/bisync"
        state: directory
        owner: "{{ rclone_user }}"
        group: "{{ rclone_user }}"
        mode: '0755'

    - name: Create systemd service for rclone bisync
      copy:
        dest: /etc/systemd/system/rclone-sync-documents.service
        mode: '0644'
        content: |
          [Unit]
          Description=Rclone bidirectional sync - Google Drive Documents to OneDrive Documents
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=oneshot
          User={{ rclone_user }}
          Group={{ rclone_user }}
          ExecStart=/usr/bin/rclone bisync {{ gdrive_remote }}:{{ gdrive_path }} {{ onedrive_remote }}:{{ onedrive_path }} \
            --verbose \
            --check-access \
            --remove-empty-dirs

          # Logging
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=rclone-sync

          # Security
          PrivateTmp=true
          NoNewPrivileges=true

          [Install]
          WantedBy=multi-user.target
      notify: Reload systemd

    - name: Create systemd timer for rclone bisync
      copy:
        dest: /etc/systemd/system/rclone-sync-documents.timer
        mode: '0644'
        content: |
          [Unit]
          Description=Run rclone bisync every {{ sync_interval }}

          [Timer]
          OnBootSec=5min
          OnUnitActiveSec={{ sync_interval }}
          AccuracySec=1min
          Persistent=true

          [Install]
          WantedBy=timers.target
      notify: Reload systemd

    - name: Flush handlers to reload systemd
      meta: flush_handlers

    - name: Check if bisync has been initialized
      stat:
        path: "/home/{{ rclone_user }}/.cache/rclone/bisync/{{ gdrive_remote }}_{{ gdrive_path }}.{{ onedrive_remote }}_{{ onedrive_path }}.path1.lst-new"
      register: bisync_initialized

    - name: Run initial bisync with --resync flag
      command: >
        rclone bisync {{ gdrive_remote }}:{{ gdrive_path }} {{ onedrive_remote }}:{{ onedrive_path }}
        --verbose
        --check-access
        --remove-empty-dirs
        --resync
      become_user: "{{ rclone_user }}"
      when: not bisync_initialized.stat.exists
      register: initial_sync

    - name: Display initial sync output
      debug:
        var: initial_sync.stdout_lines
      when: not bisync_initialized.stat.exists

    - name: Enable and start rclone sync timer
      systemd:
        name: rclone-sync-documents.timer
        enabled: true
        state: started
        daemon_reload: true

    - name: Display sync status
      debug:
        msg:
          - "Rclone bidirectional sync configured successfully!"
          - "Syncing: {{ gdrive_remote }}:{{ gdrive_path }} <-> {{ onedrive_remote }}:{{ onedrive_path }}"
          - "Frequency: Every {{ sync_interval }}"
          - "View logs: journalctl -u rclone-sync-documents.service -f"
          - "Check timer status: systemctl status rclone-sync-documents.timer"
          - "Run manual sync: systemctl start rclone-sync-documents.service"

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: true

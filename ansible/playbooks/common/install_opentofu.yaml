---
- name: Install OpenTofu Infrastructure as Code Tool
  hosts: rpi
  become: true
  gather_facts: true

  vars:
    opentofu_installer_url: "https://get.opentofu.org/install-opentofu.sh"
    opentofu_installer_path: "/tmp/install-opentofu.sh"
    opentofu_install_method: "deb"

  tasks:
    - name: Download OpenTofu installer script
      get_url:
        url: "{{ opentofu_installer_url }}"
        dest: "{{ opentofu_installer_path }}"
        mode: '0700'
      register: opentofu_installer_download

    - name: Display installer download status
      debug:
        msg: "OpenTofu installer downloaded successfully"
      when: opentofu_installer_download.changed

    - name: Run OpenTofu installer with deb method
      shell: "{{ opentofu_installer_path }} --install-method {{ opentofu_install_method }}"
      register: opentofu_installation
      changed_when: "'tofu' in opentofu_installation.stdout | lower"

    - name: Display OpenTofu installation output
      debug:
        msg: "{{ opentofu_installation.stdout }}"
      when: opentofu_installation.stdout | length > 0

    - name: Remove OpenTofu installer script
      file:
        path: "{{ opentofu_installer_path }}"
        state: absent

    - name: Verify OpenTofu installation
      command: tofu version
      register: opentofu_version_check
      changed_when: false

    - name: Display OpenTofu version
      debug:
        msg: "OpenTofu installed: {{ opentofu_version_check.stdout }}"

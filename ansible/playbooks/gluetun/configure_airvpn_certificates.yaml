---
# Configure AirVPN certificates for Gluetun containers
# This playbook fetches AirVPN client certificates from Bitwarden and deploys them
# to both the gluetun and tailscale-airvpn stack directories on the Docker host
#
# Prerequisites:
# 1. airvpn_crt_uuid and airvpn_key_uuid must be defined in vault secrets
# 2. docker_ssh_password_uuid must be defined in vault secrets
# 3. bws_access_token must be set
# 4. Certificate and key stored in Bitwarden Secrets Manager
#
# Usage:
# ansible-playbook -i inventory/hosts.yaml playbooks/gluetun/configure_airvpn_certificates.yaml

# Fetch credentials and certificates from Bitwarden Secrets Manager
- name: Fetch Bitwarden Secrets
  hosts: localhost
  connection: local
  gather_facts: false
  tags: always

  tasks:
    - name: Fetch Docker SSH password from Bitwarden
      shell: bws secret get {{ docker_ssh_password_uuid }} --access-token "{{ bws_access_token }}" --output json
      register: docker_ssh_password_result
      changed_when: false
      no_log: true
      when: docker_ssh_password_uuid is defined

    - name: Fetch AirVPN client certificate from Bitwarden
      shell: bws secret get {{ airvpn_crt_uuid }} --access-token "{{ bws_access_token }}" --output json
      register: airvpn_crt_result
      changed_when: false
      no_log: true
      when: airvpn_crt_uuid is defined

    - name: Fetch AirVPN client key from Bitwarden
      shell: bws secret get {{ airvpn_key_uuid }} --access-token "{{ bws_access_token }}" --output json
      register: airvpn_key_result
      changed_when: false
      no_log: true
      when: airvpn_key_uuid is defined

    - name: Fetch Tailscale + AirVPN client certificate from Bitwarden
      shell: bws secret get {{ tailscale_airvpn_crt_uuid }} --access-token "{{ bws_access_token }}" --output json
      register: tailscale_airvpn_crt_result
      changed_when: false
      no_log: true
      when: tailscale_airvpn_crt_uuid is defined

    - name: Fetch Tailscale + AirVPN client key from Bitwarden
      shell: bws secret get {{ tailscale_airvpn_key_uuid }} --access-token "{{ bws_access_token }}" --output json
      register: tailscale_airvpn_key_result
      changed_when: false
      no_log: true
      when: tailscale_airvpn_key_uuid is defined

    - name: Set Docker SSH password fact
      set_fact:
        docker_ssh_pass: "{{ (docker_ssh_password_result.stdout | from_json).value }}"
      no_log: true
      when:
        - docker_ssh_password_uuid is defined
        - docker_ssh_password_result.stdout is defined

    - name: Set AirVPN certificate facts
      set_fact:
        airvpn_crt_content: "{{ (airvpn_crt_result.stdout | from_json).value }}"
        airvpn_key_content: "{{ (airvpn_key_result.stdout | from_json).value }}"
      no_log: true
      when:
        - airvpn_crt_uuid is defined
        - airvpn_key_uuid is defined
        - airvpn_crt_result.stdout is defined
        - airvpn_key_result.stdout is defined

    - name: Set Tailscale + AirVPN certificate facts
      set_fact:
        tailscale_airvpn_crt_content: "{{ (tailscale_airvpn_crt_result.stdout | from_json).value }}"
        tailscale_airvpn_key_content: "{{ (tailscale_airvpn_key_result.stdout | from_json).value }}"
      no_log: true
      when:
        - tailscale_airvpn_crt_uuid is defined
        - tailscale_airvpn_key_uuid is defined
        - tailscale_airvpn_crt_result.stdout is defined
        - tailscale_airvpn_key_result.stdout is defined

    - name: Add docker host to inventory with credentials
      add_host:
        name: docker
        ansible_host: "{{ docker_ip }}"
        ansible_user: dockeruser
        ansible_ssh_pass: "{{ docker_ssh_pass }}"
        ansible_become_pass: "{{ docker_ssh_pass }}"
        airvpn_crt_content: "{{ airvpn_crt_content }}"
        airvpn_key_content: "{{ airvpn_key_content }}"
        tailscale_airvpn_crt_content: "{{ tailscale_airvpn_crt_content }}"
        tailscale_airvpn_key_content: "{{ tailscale_airvpn_key_content }}"
      no_log: true
      when:
        - docker_ssh_pass is defined
        - airvpn_crt_content is defined
        - airvpn_key_content is defined
        - tailscale_airvpn_crt_content is defined
        - tailscale_airvpn_key_content is defined

# Deploy AirVPN certificates to Docker host
- name: Deploy AirVPN Certificates to Gluetun Stacks
  hosts: docker
  become: true
  gather_facts: false

  vars:
    docker_user: dockeruser

  tasks:
    - name: Validate gluetun stack certificate content is available
      fail:
        msg: |
          AirVPN certificate content for gluetun stack not available!
          Required vault variables:
          - airvpn_crt_uuid
          - airvpn_key_uuid

          These UUIDs should reference Bitwarden secrets containing:
          - client.crt content
          - client.key content

          To generate certificates:
          1. Visit https://client.airvpn.org/
          2. Log in with your AirVPN account
          3. Download the certificates (OpenVPN 2.6 format)
          4. Extract client.crt and client.key
          5. Store the certificate and key content in Bitwarden Secrets Manager
          6. Add the secret UUIDs to ansible vault as airvpn_crt_uuid and airvpn_key_uuid
      when: airvpn_crt_content is not defined or airvpn_key_content is not defined

    - name: Validate tailscale-airvpn stack certificate content is available
      fail:
        msg: |
          AirVPN certificate content for tailscale-airvpn stack not available!
          Required vault variables:
          - tailscale_airvpn_crt_uuid
          - tailscale_airvpn_key_uuid

          These UUIDs should reference Bitwarden secrets containing separate:
          - client.crt content (for Tailscale + AirVPN stack)
          - client.key content (for Tailscale + AirVPN stack)

          To generate certificates:
          1. Visit https://client.airvpn.org/
          2. Log in with your AirVPN account
          3. Download the certificates (OpenVPN 2.6 format)
          4. Extract client.crt and client.key
          5. Store the certificate and key content in Bitwarden Secrets Manager
          6. Add the secret UUIDs to ansible vault as tailscale_airvpn_crt_uuid and tailscale_airvpn_key_uuid
      when: tailscale_airvpn_crt_content is not defined or tailscale_airvpn_key_content is not defined

    - name: Create gluetun config directory
      file:
        path: /mnt/docker/config/gluetun/config
        state: directory
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0755'

    - name: Create tailscale-airvpn gluetun config directory
      file:
        path: /mnt/docker/config/tailscale-airvpn/gluetun
        state: directory
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0755'

    - name: Write AirVPN client certificate to gluetun stack config
      copy:
        content: "{{ airvpn_crt_content }}"
        dest: /mnt/docker/config/gluetun/config/client.crt
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0600'
      no_log: true

    - name: Write AirVPN client key to gluetun stack config
      copy:
        content: "{{ airvpn_key_content }}"
        dest: /mnt/docker/config/gluetun/config/client.key
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0600'
      no_log: true

    - name: Write Tailscale + AirVPN client certificate to tailscale-airvpn stack config
      copy:
        content: "{{ tailscale_airvpn_crt_content }}"
        dest: /mnt/docker/config/tailscale-airvpn/gluetun/client.crt
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0600'
      no_log: true

    - name: Write Tailscale + AirVPN client key to tailscale-airvpn stack config
      copy:
        content: "{{ tailscale_airvpn_key_content }}"
        dest: /mnt/docker/config/tailscale-airvpn/gluetun/client.key
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0600'
      no_log: true

    - name: Display completion message
      debug:
        msg: |
          AirVPN certificates deployed successfully!

          Gluetun stack certificates:
          - /mnt/docker/config/gluetun/config/client.crt
          - /mnt/docker/config/gluetun/config/client.key

          Tailscale + AirVPN stack certificates:
          - /mnt/docker/config/tailscale-airvpn/gluetun/client.crt
          - /mnt/docker/config/tailscale-airvpn/gluetun/client.key

          Next steps:
          1. Go to Portainer
          2. Restart the gluetun container in the gluetun stack
          3. Restart the gluetun-ts container in the tailscale-airvpn stack
          4. Check container logs to verify "VPN connected" message
          5. Confirm tailscale is connected and advertising exit node
          6. Enable the exit node in Tailscale admin console

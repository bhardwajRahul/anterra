---
# Configure AirVPN certificates for Gluetun container
# This playbook copies the AirVPN client certificates (client.crt and client.key)
# to the gluetun container config directory on the Docker host
#
# Prerequisites:
# 1. Place client.crt and client.key files in ansible/playbooks/gluetun/airvpn-certs/
# 2. Generate these from AirVPN dashboard: https://client.airvpn.org/
# 3. docker_ssh_password_uuid must be defined in vault secrets
# 4. bws_access_token must be set
#
# Usage:
# ansible-playbook -i inventory/hosts.yaml playbooks/gluetun/configure_airvpn_certificates.yaml

# Fetch Docker SSH password from Bitwarden Secrets Manager
- name: Fetch Docker Credentials
  hosts: localhost
  connection: local
  gather_facts: false
  tags: always

  tasks:
    - name: Fetch Docker SSH password from Bitwarden
      shell: bws secret get {{ docker_ssh_password_uuid }} --access-token "{{ bws_access_token }}" --output json
      register: docker_ssh_password_result
      changed_when: false
      no_log: true
      when: docker_ssh_password_uuid is defined

    - name: Set Docker SSH password fact
      set_fact:
        docker_ssh_pass: "{{ (docker_ssh_password_result.stdout | from_json).value }}"
      no_log: true
      when:
        - docker_ssh_password_uuid is defined
        - docker_ssh_password_result.stdout is defined

    - name: Add docker host to inventory with credentials
      add_host:
        name: docker
        ansible_host: "{{ docker_ip }}"
        ansible_user: dockeruser
        ansible_ssh_pass: "{{ docker_ssh_pass }}"
        ansible_become_pass: "{{ docker_ssh_pass }}"
      no_log: true
      when:
        - docker_ssh_pass is defined

# Deploy AirVPN certificates to Docker host
- name: Deploy AirVPN Certificates to Gluetun
  hosts: docker
  become: true
  gather_facts: false

  vars:
    airvpn_certs_source: "{{ playbook_dir }}/airvpn-certs"
    gluetun_config_path: "/mnt/docker/config/gluetun/config"
    docker_user: dockeruser

  tasks:
    - name: Check if AirVPN certificate files exist locally
      stat:
        path: "{{ item }}"
      register: cert_files
      loop:
        - "{{ airvpn_certs_source }}/client.crt"
        - "{{ airvpn_certs_source }}/client.key"
      delegate_to: localhost
      become: false

    - name: Fail if certificate files not found
      fail:
        msg: |
          AirVPN certificate files not found!
          Expected location: {{ airvpn_certs_source }}/
          Required files: client.crt, client.key

          To generate certificates:
          1. Visit https://client.airvpn.org/
          2. Log in with your AirVPN account
          3. Download the certificates (OpenVPN 2.6 format)
          4. Extract client.crt and client.key
          5. Place them in: {{ airvpn_certs_source }}/
      when: cert_files.results[0].stat.exists == false or cert_files.results[1].stat.exists == false

    - name: Create gluetun config directory
      file:
        path: "{{ gluetun_config_path }}"
        state: directory
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0755'

    - name: Copy AirVPN client certificate to gluetun config
      copy:
        src: "{{ airvpn_certs_source }}/client.crt"
        dest: "{{ gluetun_config_path }}/client.crt"
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0600'

    - name: Copy AirVPN client key to gluetun config
      copy:
        src: "{{ airvpn_certs_source }}/client.key"
        dest: "{{ gluetun_config_path }}/client.key"
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0600'

    - name: Display completion message
      debug:
        msg: |
          AirVPN certificates deployed successfully!

          Certificates copied to:
          - {{ gluetun_config_path }}/client.crt
          - {{ gluetun_config_path }}/client.key

          Next steps:
          1. Go to Portainer
          2. Find the gluetun container and restart it manually
          3. Check container logs to verify "VPN connected" message
          4. Confirm all dependent containers are routing through VPN

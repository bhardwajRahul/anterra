# Jotty

Jotty is a self-hosted notes and checklists application, authenticated via Cloudflare Zero Trust OIDC (SSO-only, no local fallback).

## Deployment Details

- **URL**: https://jotty.example.com
- **Stack Location**: `opentofu/portainer/compose-files/jotty.yaml.tpl`
- **Deployment Endpoint**: docker_pve2
- **DNS Management**: Cloudflare (proxied)
- **Reverse Proxy**: VPS Caddy instance via Tailscale
- **Container Port**: 1122 (maps to 3000 inside container)

## Stack Components

| Container | Image | Purpose |
|-----------|-------|---------|
| jotty | ghcr.io/fccview/jotty:latest | Main application |

## Required Bitwarden Secrets

| Secret Variable | Description |
|-----------------|-------------|
| `jotty_oidc_issuer_secret_id` | Cloudflare Zero Trust OIDC issuer URL |
| `jotty_oidc_client_id_secret_id` | Cloudflare Zero Trust OIDC client ID |
| `jotty_oidc_client_secret_secret_id` | Cloudflare Zero Trust OIDC client secret |

All three values are generated by Cloudflare when creating a SaaS application with OIDC protocol.

## Initial Setup

1. Create a **SaaS application** in Cloudflare Zero Trust (Access > Applications):
   - Protocol: OIDC
   - Scopes: `openid`, `email`, `profile`
   - Redirect URI: `https://jotty.example.com/api/oidc/callback`
   - PKCE: enabled (with client secret required)
2. Store the issuer URL, client ID, and client secret in Bitwarden
3. Configure secret UUIDs in `opentofu/portainer/tofu.auto.tfvars`
4. Create data directories on docker_pve2 (handled by `setup_docker_portainer_server.yaml` playbook)
5. Deploy in order:
   - Caddy reverse proxy
   - Cloudflare DNS (`tofu apply`)
   - Portainer stack (`tofu apply`)
6. Visit the URL -- first user authenticated via SSO becomes admin

## Volume Mounts

| Container Path | Host Path | Purpose |
|----------------|-----------|---------|
| `/app/data` | `${docker_data_path}/jotty/data` | Notes, users, settings |
| `/app/config` | `${docker_data_path}/jotty/config` | Themes, customization |
| `/app/.next/cache` | `${docker_data_path}/jotty/cache` | Next.js build cache |

## Security Configuration

- **SSO-only**: Local authentication is disabled (`SSO_FALLBACK_LOCAL=no`)
- **PKCE enabled**: Authorization code interception protection, used alongside client secret
- **Non-root container**: Runs as `1000:1000`
- **Cloudflare proxy**: Traffic proxied through Cloudflare for DDoS protection

## Important Notes

- Cloudflare Zero Trust application must be **SaaS** type (not Self-hosted) because Jotty implements standard OIDC client flows
- The redirect URI must be exactly `https://jotty.example.com/api/oidc/callback` (not `/api/auth/callback/oidc`)
- PKCE must be enabled in Cloudflare -- Jotty sends PKCE parameters by default and Cloudflare rejects requests if PKCE is disabled
- Volume directories must be owned by `1000:1000` before first start to avoid permission errors
- `INTERNAL_API_URL=http://localhost:3000` is required to prevent 403 errors when running behind a reverse proxy

## References

- [Jotty GitHub](https://github.com/fccview/jotty)
- [Jotty Docker Setup](https://github.com/fccview/jotty/blob/main/howto/DOCKER.md)
- [Jotty SSO Guide](https://github.com/fccview/jotty/blob/main/howto/SSO.md)
- [Cloudflare OIDC SaaS Apps](https://developers.cloudflare.com/cloudflare-one/applications/configure-apps/saas-apps/generic-oidc-saas/)
